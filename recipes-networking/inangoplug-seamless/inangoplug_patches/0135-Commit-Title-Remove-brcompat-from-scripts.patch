From ad9146a22b4222371492ba1e3534ffe24bccd306 Mon Sep 17 00:00:00 2001
From: Petr Bernatskii <p.bernatskii@inango-systems.com>
Date: Wed, 2 Mar 2022 19:09:37 +0500
Subject: [PATCH] Commit Title          : Remove brcompat from scripts

BugID                 : 27448
Bug Fixed(y/N[blankN]):
CodeReviewId          : 0
Description           : Removed brcompat related code from scripts
---
 utilities/ovs-ctl.in      | 54 +----------------------------------------------
 utilities/ovs-kmod-ctl.in | 24 ---------------------
 utilities/ovs-lib.in      |  8 -------
 3 files changed, 1 insertion(+), 85 deletions(-)

diff --git a/utilities/ovs-ctl.in b/utilities/ovs-ctl.in
index 0b61912cf..104eecd93 100644
--- a/utilities/ovs-ctl.in
+++ b/utilities/ovs-ctl.in
@@ -253,46 +253,6 @@ start_forwarding () {
     return 0
 }
 
-do_start_brcompatd () {
-    if daemon_is_running ovs-brcompatd; then
-        log_success_msg "ovs-brcompatd is already running"
-    else
-        # Start ovs-brcompatd.
-        set ovs-brcompatd
-        if test X"$SELF_CONFINEMENT" = Xno; then
-            set "$@" --no-self-confinement
-        fi
-        [ "$OVS_USER" != "" ] && set "$@" --user "$OVS_USER"
-
-        start_daemon "$OVS_BRCOMPATD_PRIORITY" "$OVS_BRCOMPATD_WRAPPER" "$@" ||
-            return 1
-
-        action "Enabling proactive mode" \
-            ovs-appctl upcall/enable-proactive-mode
-
-        action "Set tcp flags always wildcards" \
-            ovs-appctl upcall/enable-megaflows-mask-fields tcp_flags
-
-        action "Disabling megaflows in OVS datapath" \
-            ovs-appctl upcall/disable-megaflows
-
-        action "Disabling the flow hardware offload" \
-            ovs-vsctl set Open_vSwitch . other_config:hw-offload=false
-
-        action "Set max-revalidator time to 2000ms" \
-            ovs-vsctl --no-wait set Open_vSwitch . other_config:max-revalidator=2000
-    fi
-}
-
-start_brcompatd () {
-    if test X"$OVS_BRCOMPATD" = Xyes; then
-        do_start_brcompatd || return 1
-        touch /tmp/inangoplug_started
-    fi
-
-    return 0
-}
-
 start_ovs_ipsec () {
     ${datadir}/scripts/ovs-monitor-ipsec \
         --pidfile=${rundir}/ovs-monitor-ipsec.pid \
@@ -317,13 +277,6 @@ stop_forwarding () {
     fi
 }
 
-stop_brcompatd () {
-    if test X"$OVS_BRCOMPATD" = Xyes; then
-        stop_daemon ovs-brcompatd
-        rm -f /tmp/inangoplug_started
-    fi
-}
-
 stop_ovs_ipsec () {
     ${bindir}/ovs-appctl -t ovs-monitor-ipsec exit || return 1
     return 0
@@ -395,13 +348,10 @@ set_defaults () {
     OVS_USER=
     OVSDB_SERVER=yes
     OVS_VSWITCHD=yes
-    OVS_BRCOMPATD=yes
     OVSDB_SERVER_PRIORITY=-10
     OVS_VSWITCHD_PRIORITY=-10
-    OVS_BRCOMPATD_PRIORITY=-10
     OVSDB_SERVER_WRAPPER=
     OVS_VSWITCHD_WRAPPER=
-    OVS_BRCOMPATD_WRAPPER=
     OVSDB_SERVER_OPTIONS=
     OVS_VSWITCHD_OPTIONS=
     OVS_BRIDGES=
@@ -538,7 +488,7 @@ set_option () {
 }
 
 daemons () {
-    echo ovsdb-server ovs-vswitchd ovs-brcompatd
+    echo ovsdb-server ovs-vswitchd
 }
 
 set_defaults
@@ -602,11 +552,9 @@ case $command in
     start)
         start_ovsdb || exit 1
         start_forwarding || exit 1
-        start_brcompatd || exit 1
         add_managers
         ;;
     stop)
-        stop_brcompatd
         stop_forwarding
         stop_ovsdb
         ;;
diff --git a/utilities/ovs-kmod-ctl.in b/utilities/ovs-kmod-ctl.in
index fee0f0916..462173931 100644
--- a/utilities/ovs-kmod-ctl.in
+++ b/utilities/ovs-kmod-ctl.in
@@ -36,20 +36,6 @@ insert_mods () {
     action "Inserting openvswitch module" modprobe openvswitch
 }
 
-insert_brc_mods () {
-    if test -e /sys/module/bridge; then
-        # Try loading brcompat kernel module.
-        if test X"$OVS_BRIDGES" != X; then
-            action "Inserting openvswitch module" modprobe brcompat bridges=$OVS_BRIDGES
-        else
-            action "Inserting openvswitch module" modprobe brcompat
-        fi
-    else
-        log_failure_msg "You need to load the Linux bridge module before the brcompat module will be loaded."
-        return 1
-    fi
-}
-
 insert_kmods_if_required() {
     # If this kernel has no module support, expect we're done.
     if test ! -e /proc/modules
@@ -64,12 +50,6 @@ insert_kmods_if_required() {
         insert_mods || return 1
     fi
 
-    # If brcompat is already loaded then we're done.
-    if ! test -e /sys/module/brcompat; then
-        # Load brcompat.  If that's successful then we're done.
-        insert_brc_mods || return 1
-    fi
-
     return 0
 }
 
@@ -90,10 +70,6 @@ remove_kmods() {
         action "Removing openvswitch module" rmmod openvswitch
     fi
 
-    if test -e /sys/module/brcompat; then
-        action "Removing openvswitch module" rmmod brcompat
-    fi
-
     # Older releases may be using the rtnetlink interface while a
     # newer release will want to use the internal compat interface
     # for geneve and vxlan.
diff --git a/utilities/ovs-lib.in b/utilities/ovs-lib.in
index 1300bac9b..bf1fa9914 100644
--- a/utilities/ovs-lib.in
+++ b/utilities/ovs-lib.in
@@ -651,10 +651,6 @@ force_reload_kmod () {
     flow_restore_wait
     start_forwarding || return 1
 
-    # Restart the ovs-brcompatd
-    stop_brcompatd
-    start_brcompatd || return 1
-
     # Restore saved flows and inform vswitchd that we are done.
     restore_flows
     flow_restore_complete
@@ -689,10 +685,6 @@ restart () {
     flow_restore_wait
     start_forwarding || return 1
 
-    # Restart the ovs-brcompatd
-    stop_brcompatd
-    start_brcompatd || return 1
-
     # Restore saved flows and inform vswitchd that we are done.
     restore_flows
     flow_restore_complete
